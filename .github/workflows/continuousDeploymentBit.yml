name: Continuous Deployment bit.dev

on:
  workflow_call:
    inputs:
      SCOPE_NAME:
        description: 'The name of the scope.
                      Eg. dechea.orc, dechea.hes'
        required: true
        type: string
    secrets:
      BIT_TOKEN:
        description: 'The token used to access your bit.dev environment.
                      Managed by Doppler'
        required: true

jobs:
  tag-and-export:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Use Node.js 14
        uses: actions/setup-node@v3
        with:
          node-version: 14

      - name: Install Bit Version Manager
        run: npm i -g @teambit/bvm
      - name: Install latest Bit version
        run: bvm install
      - name: add bvm bin folder to path
        run: echo "$HOME/bin" >> $GITHUB_PATH

      - name: Set up bit config
        run: |
          bit config set analytics_reporting false
          bit config set anonymous_reporting false
          bit config set user.token ${{ secrets.BIT_TOKEN }}

      - name: Install packages using bit
        run: |
          bit install

      - name: Create or use existing lane for pending components
        if: github.event_name == 'push' && github.ref_name != 'main'
        run: |
          BRANCH_NAME=${{ github.ref_name }}
          BRANCH_NAME="${BRANCH_NAME##*/}"
          BRANCH_NAME="${BRANCH_NAME,,}"
          bit lane switch ${{ inputs.SCOPE_NAME }}/$BRANCH_NAME --get-all || bit lane create $BRANCH_NAME
          bit snap -m "add new feature"
          bit export

      - name: Test pending components
        if: github.event_name == 'push' && github.ref_name != 'main'
        run: bit test -s ${{ inputs.SCOPE_NAME }}

      - name: Hard-tag pending components
        if: github.event_name == 'pull_request' && github.event.pull_request.merged == true && github.base_ref == 'main'
        run: |
          bit lane switch ${{ inputs.SCOPE_NAME }}/${{ github.head_ref }} --get-all
          bit lane switch main
          bit lane merge ${{ github.head_ref }}
          bit tag --snapped

      - name: Commit changes made to .bitmap
        if: github.event_name == 'pull_request' && github.event.pull_request.merged == true && github.base_ref == 'main'
        uses: EndBug/add-and-commit@v9
        with:
          add: .bitmap
          author_name: ${{ github.actor }}
          message: "update .bitmap with new component versions (automated). --skip-ci"
